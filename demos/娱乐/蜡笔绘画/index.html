<!DOCTYPE HTML>
<html lang="en-US">
<head>
	<meta charset="UTF-8">
	<title></title>
	<style type="text/css">
		canvas {
			margin:10px;
			border:1px solid #0f0;
		}
	</style>
</head>
<body>
	<div>
		<span class="highlight">Choose a size: </span>
		<button type="button" id="chooseSmallSimpleSizes" class="selectSizeBtn">Small</button>
		<button type="button" id="chooseNormalSimpleSizes" class="selectSizeBtn">Normal</button>
		<button type="button" id="chooseLargeSimpleSizes" class="selectSizeBtn">Large</button>
		<button type="button" id="chooseHugeSimpleSizes" class="selectSizeBtn">Huge</button>
	</div>
	<div><span class="highlight">Choose a color: </span>
		<button type="button" id="choosePurpleSimpleColors" class="selectColorBtn">Purple</button>
		<button type="button" id="chooseGreenSimpleColors" class="selectColorBtn">Green</button>
		<button type="button" id="chooseYellowSimpleColors" class="selectColorBtn">Yellow</button>
		<button type="button" id="chooseBrownSimpleColors" class="selectColorBtn">Brown</button>
	</div>
	
	
	<div id="canvasDiv"></div>
	<button id = "save">保存(另存为下面的图片)</button>
	<br/>
	<img id= "outputImg"/>
	<script src="http://libs.baidu.com/jquery/1.9.0/jquery.js"></script>
	<!--[if IE]><script type="text/javascript" src="excanvas.js"></script><![endif]-->
	<script type="text/javascript">
		//参考 http://www.williammalone.com/articles/create-html5-canvas-javascript-drawing-app/
		//要改进，1，笔触的控制，用拖动的，2，颜色的控制，colorPicker 3，撤销（移除最近的5点）4，整体设计 5，找一些其他图片 6，从本地选图片
		//在script中创建canvas是为了兼容ie
		(function(){
			var clickX = [],
				clickY = [],
				clickDrag = [],
				clickColor = [],
				nowColor,
				clickSize = [],
				nowSize,
				context,
				paint,
				canvasWidth = 490,
				canvasHeight = 220,
				$Canvas,
				crayonTextureImage,
				outlineImage,
				curLoadResNum = 0,
				totalLoadResources = 2;
			var colorMap = {
				'choosePurpleSimpleColors':'#cb3594',
				'chooseGreenSimpleColors':'#659b41',
				'chooseYellowSimpleColors':'#ffcf33',
				'chooseBrownSimpleColors':'#986928'
			},
			sizeMap = {
				'chooseSmallSimpleSizes':'3',
				'chooseNormalSimpleSizes':'5',
				'chooseLargeSimpleSizes':'10',
				'chooseHugeSimpleSizes':'15'
			};
			$(function(){
				context = getCtx();
				$Canvas = $('#canvas');
				nowColor = colorMap.choosePurpleSimpleColors;
				nowSize = sizeMap.chooseNormalSimpleSizes;
				crayonTextureImage = new Image();
				crayonTextureImage.onload = function() { 
					resourceLoaded(); 
				};
				crayonTextureImage.src = "images/crayon-texture.png";
				
				outlineImage = new Image();
				outlineImage.onload = function() { 
					resourceLoaded(); 
				};
				outlineImage.src = "images/watermelon-duck-outline.png";
				
				$Canvas.mousedown(function(e){
				  var mouseX = e.pageX - this.offsetLeft;
				  var mouseY = e.pageY - this.offsetTop;
						
				  paint = true;//开始绘图
				  addClick(mouseX, mouseY, false);
				  redraw();
				});
				
				$Canvas.mousemove(function(e){
				  if(paint){
					addClick(e.pageX - this.offsetLeft, e.pageY - this.offsetTop, true);
					redraw();
				  }
				});
				
				$Canvas.mouseup(function(e){
				  paint = false;
				});
				
				$(".selectColorBtn").click(function(){
					nowColor = colorMap[this.id];
				});
				
				$(".selectSizeBtn").click(function(){
					nowSize = sizeMap[this.id];
				});
				
				$("#save").click(function(){
					$("#outputImg").attr("src",$("#canvas")[0].toDataURL());
				});
				
			});
			
			function getCtx(){
				var canvasDiv = document.getElementById('canvasDiv');
					canvas = document.createElement('canvas');
					canvas.setAttribute('width', canvasWidth);
					canvas.setAttribute('height', canvasHeight);
					canvas.setAttribute('id', 'canvas');
					canvasDiv.appendChild(canvas);
				if(typeof G_vmlCanvasManager != 'undefined') {
					canvas = G_vmlCanvasManager.initElement(canvas);
				}
				context = canvas.getContext("2d");
				return context;
			};
			
			
			function addClick(x, y, dragging)
			{
			  clickX.push(x);
			  clickY.push(y);
			  clickColor.push(nowColor);
			  clickSize.push(nowSize);
			  clickDrag.push(dragging);

			}
			
			function resourceLoaded()
			{
				if(++curLoadResNum >= totalLoadResources){
					redraw();
				}
			};
			function redraw(){
				var drawingAreaX = 111;
				var drawingAreaY = 11;
				var drawingAreaWidth = 267;
				var drawingAreaHeight = 200;
			  context.clearRect(0, 0, context.canvas.width, context.canvas.height); // Clears the canvas
			  
			  context.strokeStyle = "#df4b26";
			  context.lineJoin = "round";
			  context.lineWidth = 5;
						
			  for(var i=0; i < clickX.length; i++) {		
				context.beginPath();
				if(clickDrag[i] && i){//是画一条线还是一个点
				  context.moveTo(clickX[i-1], clickY[i-1]);
				 }else{
				   context.moveTo(clickX[i]-1, clickY[i]);
				 }
				 context.lineTo(clickX[i], clickY[i]);
				 context.closePath();
				 context.strokeStyle = clickColor[i];
				 context.lineWidth = clickSize[i];
				 context.stroke();
			  }
			  context.globalAlpha = 0.4;
			  context.drawImage(crayonTextureImage, 0, 0, canvasWidth, canvasHeight);
			  //context.globalAlpha = 1; // No IE support
	
			// Draw the outline image
			  context.drawImage(outlineImage, drawingAreaX, drawingAreaY, drawingAreaWidth, drawingAreaHeight);
			}
		})();
		
	
	</script>
</body>
</html>